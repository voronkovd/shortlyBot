services:
  bot:
    image: ghcr.io/voronkovd/shortlybot:latest
    container_name: shortlybot_bot
    environment:
      RMQ_HEARTBEAT: "120"
      RMQ_PUBLISH_RETRIES: "5"
      RABBITMQ_HOST: ${RABBITMQ_HOST}
      RABBITMQ_PORT: ${RABBITMQ_PORT}
      RABBITMQ_USER: ${RABBITMQ_USER}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}

      YTDLP_COOKIES_FILE: /secrets/yt_cookies.txt
      TZ: Europe/Amsterdam
    volumes:
      - ./secrets/yt_cookies.txt:/secrets/yt_cookies.txt:ro
    sysctls:
      - net.ipv4.tcp_keepalive_time=60
      - net.ipv4.tcp_keepalive_intvl=10
      - net.ipv4.tcp_keepalive_probes=3
    networks:
      - shortlybot
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "python -c \"import os,urllib.request,json,sys; d=json.load(urllib.request.urlopen('https://api.telegram.org/bot'+os.environ.get('TELEGRAM_BOT_TOKEN','')+'/getMe',timeout=5)); sys.exit(0 if d.get('ok') else 1)\""
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s

networks:
  shortlybot:
    external: true