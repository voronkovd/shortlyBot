name: Dependencies Check

on:
  schedule:
    - cron: '0 9 * * 1'   # –∫–∞–∂–¥—ã–π –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 09:00 UTC
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/poetry.lock') }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: List outdated packages
        run: pip list --outdated --format=columns || true

      - name: Dependency vulnerability scan (pip-audit)
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt -f json -o pip-audit.json || true

      - name: Static analysis (bandit)
        run: |
          pip install bandit
          bandit -r . -f json -o bandit.json || true

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: dep-security-reports
          path: |
            pip-audit.json
            bandit.json
          if-no-files-found: ignore

      - name: Create/Update issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            function readJsonSafe(path) {
              try { return JSON.parse(fs.readFileSync(path, 'utf8')); }
              catch { return null; }
            }

            const audit = readJsonSafe('pip-audit.json') || [];
            const bandit = readJsonSafe('bandit.json') || { results: [] };

            const depFindings = Array.isArray(audit) ? audit.length : 0;
            const codeFindings = Array.isArray(bandit.results) ? bandit.results.length : 0;

            if (depFindings === 0 && codeFindings === 0) {
              console.log('No vulnerabilities found');
              return;
            }

            const title = 'üö® Security vulnerabilities detected';
            const body =
              `## Dependency & Code Security Report\n\n` +
              `- Dependency issues (pip-audit): **${depFindings}**\n` +
              `- Code issues (bandit): **${codeFindings}**\n\n` +
              (depFindings ? '### pip-audit findings (top 10):\n' +
                audit.slice(0,10).map(f =>
                  `- ${f.name} ${f.version} ‚Üí ${f.fix_version || 'no fix'} | ${f.vulns?.[0]?.id || ''} ${f.vulns?.[0]?.severity || ''}`
                ).join('\n') + '\n\n' : '') +
              (codeFindings ? '### bandit findings (top 10):\n' +
                bandit.results.slice(0,10).map(v =>
                  `- ${v.test_name} (${v.severity}) at ${v.filename}:${v.line_number} ‚Äî ${v.issue_text}`
                ).join('\n') + '\n\n' : '') +
              `> Generated: ${new Date().toISOString()}`;

            // try to find existing open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dependencies,automated'
            });

            if (issues.length) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['security', 'dependencies', 'automated']
              });
            }

  update-dependencies:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', '**/pyproject.toml', '**/poetry.lock') }}

      - name: Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: Update requirements (pip-compile)
        run: |
          # –ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π requirements.in ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.
          # –ù–∏–∂–µ fallback, —á—Ç–æ–±—ã –Ω–µ –ø–æ–¥–º–µ–Ω—è—Ç—å —Ç–≤–æ–∏ –≤–µ—Ä—Å–∏–∏:
          if [ ! -f requirements.in ]; then
            awk -F'[<=> ]' '{print $1}' requirements.txt | sed '/^\s*$/d' | sort -u > requirements.in
          fi
          pip-compile requirements.in --upgrade
          echo "Updated requirements:"
          cat requirements.txt

      - name: Configure git to avoid fork remote issues
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          # Remove fork remote if it exists (to avoid errors)
          git remote remove fork 2>/dev/null || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'chore: update dependencies'
          body: |
            Automated dependency refresh via pip-compile.
            - Please review changes and run tests.
          branch: update-dependencies
          delete-branch: true
          labels: dependencies,automated
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          path: .
          push-to-fork: ''
